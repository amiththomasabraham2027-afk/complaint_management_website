name: ğŸš€ Build, Push & Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: complaint-app
  DOCKER_USERNAME: amiththomasabraham

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/complaint-app
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Build Success
        run: |
          echo "âœ… Docker image built and pushed successfully!"
          echo "ğŸ“¦ Images: ${{ steps.meta.outputs.tags }}"

  deploy-to-ec2:
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          # Fix Windows CRLF line endings if present
          sed -i 's/\r//' ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          # Verify key is valid
          ssh-keygen -l -f ~/.ssh/deploy_key

      - name: ğŸ“¡ Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            -o BatchMode=yes \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }} "echo 'SSH connection successful!'"

      - name: ğŸš€ Deploy application
        env:
          DOCKER_IMAGE: ${{ env.DOCKER_USERNAME }}/complaint-app:latest
          EC2_HOST: ${{ secrets.HOST }}
          EC2_USER: ${{ secrets.USERNAME }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }} 'bash -s' << 'DEPLOYEOF'
          
          set -e
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          APP_DIR="$HOME/complaint-app"
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"
          
          echo ""
          echo "ğŸ“‚ Working directory: $APP_DIR"
          
          # Clone or update repository
          echo ""
          echo "ğŸ“ Setting up repository..."
          if [ -d .git ]; then
            echo "   Updating existing repository..."
            git pull origin main --ff-only || git pull origin main
          else
            echo "   Cloning new repository..."
            git clone https://github.com/amiththomasabraham2027-afk/complaint_management_website.git .
          fi
          echo "   âœ“ Repository ready"
          
          # Create environment file
          echo ""
          echo "âš™ï¸  Creating environment configuration..."
          cat > .env.production << 'ENVEOF'
          NODE_ENV=production
          MONGODB_URI=${{ env.MONGODB_URI }}
          JWT_SECRET=${{ env.JWT_SECRET }}
          NEXTAUTH_SECRET=${{ env.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=http://${{ env.EC2_HOST }}
          NEXT_PUBLIC_API_URL=http://${{ env.EC2_HOST }}/api
          ENVEOF
          echo "   âœ“ Environment file created"
          
          # Pull latest Docker image
          echo ""
          echo "ğŸ³ Pulling Docker image..."
          docker pull ${{ env.DOCKER_IMAGE }} || echo "   Note: Image may need to be available on Docker Hub"
          echo "   âœ“ Docker image ready"
          
          # Stop existing containers
          echo ""
          echo "â¹ï¸  Stopping existing containers..."
          docker-compose -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
          echo "   âœ“ Existing containers stopped"
          
          # Start new containers
          echo ""
          echo "â–¶ï¸  Starting application containers..."
          docker-compose -f docker-compose.prod.yml up -d
          echo "   âœ“ Containers started"
          
          # Wait for application to be ready
          echo ""
          echo "â³ Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -sf http://localhost/health > /dev/null 2>&1; then
              echo "   âœ“ Application is healthy!"
              break
            fi
            echo "   Attempt $i/30..."
            sleep 2
          done
          
          # Display status
          echo ""
          echo "ğŸ“Š Container Status:"
          docker-compose -f docker-compose.prod.yml ps
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Application URL: http://${{ env.EC2_HOST }}"
          echo "ğŸ“‹ To view logs: docker-compose -f docker-compose.prod.yml logs -f complaint-app"
          echo "ğŸ”„ To restart: docker-compose -f docker-compose.prod.yml restart"
          echo ""
          
          DEPLOYEOF

      - name: ğŸ” Verify deployment
        run: |
          echo "Verifying deployment..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
            "docker-compose -f ~/complaint-app/docker-compose.prod.yml ps"

  notify-success:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: deploy-to-ec2
    if: success()

    steps:
      - name: ğŸ‰ Deployment Success
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           âœ… DEPLOYMENT SUCCESSFUL                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“¦ Docker Image: ${{ env.DOCKER_USERNAME }}/complaint-app:latest
          ğŸŒ Application: http://${{ secrets.HOST }}
          ğŸ“Š CI/CD: GitHub Actions
          ğŸ³ Container: Docker Compose
          ğŸ”„ Status: Running
          
          Next Steps:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          1. Access your application: http://${{ secrets.HOST }}
          2. Monitor logs: ssh -i resolvex_deploy.pem ubuntu@${{ secrets.HOST }}
                           docker-compose -f ~/complaint-app/docker-compose.prod.yml logs -f
          3. For issues: Check GitHub Actions logs for deployment details
          
          EOF

  notify-failure:
    name: ğŸ“¢ Failure Notification
    runs-on: ubuntu-latest
    if: failure()
    needs: [build-and-push, deploy-to-ec2]

    steps:
      - name: âŒ Deployment Failed
        run: |
          echo "âŒ Deployment failed! Check the logs above for details."
          exit 1
